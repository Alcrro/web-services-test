datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") 

}

generator client {
  provider = "prisma-client-js"

 
}

model User {
  id            Int      @id @default(autoincrement())
  name          String
  email         String   @unique
  password      String
  isVerified    Boolean @default(false)
  role          Role     @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime? @updatedAt
  clientId      String?
  Task          Task[]
  session       Session[]
}

enum Role {
  ADMIN
  USER
  DEVELOPER 
}

model Session {
  id            Int     @id @default(autoincrement())
  userId        Int     
  user          User    @relation(fields: [userId], references: [id])
  refreshToken  String  @unique
  userAgent     String?  // optional: store browser/device info
  ipAddress     String?  // optional: store IP for security audits
  createdAt     DateTime @default(now())
  expiresAt     DateTime // refresh token expiration
}

model Client {
  id          String   @id @default(uuid())
  name        String
  email       String   @unique
  phone       String?
  orders      ServiceOrder[]
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  deletedAt   DateTime?
}

model Service {
  id              Int          @id @default(autoincrement())
  uniqueId        String @unique
  name            String       @unique
  slug            String
  description     String
  isHighlight     Boolean      @default(false)
  initialPrice    Decimal      @default(0)
  isDeleted       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  deletedAt       DateTime?
  // Relations
 serviceFeatures ServiceFeature[]
  orders ServiceOrder[]
}

model Feature {
  id                Int            @id @default(autoincrement())
  uniqueId          String @unique
  name              String
  isDeleted         Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt
  deletedAt         DateTime?
  // two distinct foreign keys
 serviceFeatures    ServiceFeature[]
}

enum FeatureType {
  STANDARD
  OPTIONAL
  OTHER
}


model ServiceFeature{
  id          Int @id @default(autoincrement())
  uniqueId    String @unique
  serviceId   Int
  featureId   Int
  type        FeatureType @default(STANDARD)
  isIncluded  Boolean @default(false)
  hours       Int
  unitPrice   Decimal?
  quantity    Int? @default(1)
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  deletedAt   DateTime?

  service     Service @relation(fields: [serviceId], references: [id])
  feature     Feature @relation(fields: [featureId], references: [id])

  @@unique([serviceId, featureId])
}
model ServiceOrder {
  id              String   @id @default(uuid())
  orderNo        Int       @unique @default(autoincrement())
  projectName     String?
  serviceId       Int
  service         Service @relation(fields: [serviceId], references: [id])
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id])
  initialPrice    Decimal @default(0)
  totalPrice      Decimal 
  requirements    String?
  isDeleted       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  deletedAt       DateTime?
  // Relation for additional orders
  items           ServiceOrderItem[]
  status          ServiceOrderStatus @default(NEW)
  tasks           Task[]             // task-uri de implementare

  
  @@index([status])
  @@index([clientId])
}



enum ServiceOrderStatus {
  NEW
  IN_PROGRESS
  IN_DISCUSSION
  APPROVED
  DONE
}

model ServiceOrderItem {
  id            String   @id @default(uuid())
  orderId       String
  name          String       // ex: "responsive", "buttons-change"
  description   String?       // ex: "Make page responsive", "Update button styles"
  quantity      Int     @default(1)  
  unitPrice     Decimal?         // stored but hidden on frontend
  totalPrice    Decimal?         // internal only
  showPrice     Boolean       @default(false) // controls visibility in UI/invoices
  metadata      Json?
  isDeleted     Boolean  @default(false)
  createdAt     DateTime @default(now())
  deletedAt     DateTime?
  updatedAt     DateTime @default(now()) @updatedAt

  type          FeatureType  // "feature" | "extra" | "bugfix"
  tasks         Task[]             // subtasks pentru implementare
  serviceOrder  ServiceOrder     @relation(fields: [orderId], references: [id])
}


  
model Task {
  id            String        @id @default(uuid())
  title         String
  status        TaskStatus    @default(NOT_STARTED) // not started, in progress, done, tested
  orderItemId   String?
  orderItem     ServiceOrderItem? @relation(fields: [orderItemId], references: [id])
  orderId       String?
  order         ServiceOrder?     @relation(fields: [orderId], references: [id])
  assigneeId    Int?           // User.id developer
  assignee      User?          @relation(fields: [assigneeId], references: [id])
  githubIssueId Int?
  githubUrl     String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime?      @updatedAt
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  DONE
  TESTED
}

model UiNotification {
  id        String   @id @default(uuid())
  type      String
  title     String
  message   String
  payload   Json
  createdAt DateTime @default(now())
  read      Boolean  @default(false)

  @@map("ui_notifications") // optional, dacÄƒ vrei un nume custom pentru tabel
}